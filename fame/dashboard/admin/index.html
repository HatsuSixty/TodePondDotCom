<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script
  data-goatcounter="https://todepond.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"
></script>
<title>Todepond dot com</title>
<link rel="shortcut icon" href="/favicon.png" />
<meta property="og:image" content="/og.png" />
<link rel="stylesheet" href="/style.css" />

<style>
  #heroes-json {
    resize: vertical;
    height: 400px;
    white-space: pre;
    tab-size: 4;
  }

  main {
    display: flex;
    flex-direction: column;
    gap: 11px;
  }

  #heroes-json-log {
    color: #9faeee;
  }
</style>

<h1>Pond of fame â€” admin dashboard</h1>

<main>
  <input
    type="password"
    id="password"
    placeholder="Password"
    oninput="handlePasswordInput()"
  />

  <textarea id="heroes-json" placeholder="Loading..."></textarea>
  <section>
    <button onclick="handlePullClick()">Pull heroes</button>
    <button disabled id="heroes-json-push-button" onclick="handlePushClick()">
      Push heroes
    </button>
  </section>
  <span id="heroes-json-log">Loading...</span>
</main>

<script type="module">
  const passwordInput = document.getElementById("password");
  const heroesJsonInput = document.getElementById("heroes-json");
  const heroesJsonLog = document.getElementById("heroes-json-log");
  const heroesJsonPushButton = document.getElementById(
    "heroes-json-push-button"
  );

  const val = async (handle, name, ...args) => {
    const body = args.length > 0 ? JSON.stringify({ args }) : null;

    try {
      const response = await fetch(
        `https://api.val.town/v1/run/${handle}.${name}`,
        {
          method: "POST",
          body,
        }
      );

      const text = await response.text();
      try {
        const json = JSON.parse(text);
        return json;
      } catch (e) {
        return text;
      }
    } catch (e) {
      heroesJsonLog.textContent = "Error: " + e;
      throw e;
    }
  };

  //=============//
  // HEROES JSON //
  //=============//
  const pullHeroes = async () => {
    const heroes = await val("todepond", "getHeroes");
    heroesJsonInput.value = formatHeroes(heroes);
    return heroes;
  };

  const pushHeroes = async (heroes) => {
    heroesJsonLog.textContent = "Pushing...";
    const result = await val(
      "todepond",
      "setHeroes",
      heroes,
      originalHeroes,
      passwordInput.value
    );
    if (result.success) {
      heroesJsonLog.textContent = "Pushed!";
      originalHeroes = heroes;
    } else {
      heroesJsonLog.textContent = "Error: " + result.error;
    }
  };

  const formatHeroes = (heroes) => {
    return JSON.stringify(heroes, null, 2);
  };

  window.handlePushClick = async () => {
    try {
      JSON.parse(heroesJsonInput.value);
    } catch (e) {
      heroesJsonLog.textContent = "Invalid JSON";
      throw new Error("Invalid JSON");
    }
    const heroes = JSON.parse(heroesJsonInput.value);
    heroesJsonInput.value = formatHeroes(heroes);
    await pushHeroes(heroes, originalHeroes);
  };

  window.handlePullClick = async () => {
    heroesJsonLog.textContent = "Pulling...";
    originalHeroes = await pullHeroes();
    heroesJsonLog.textContent = "Pulled!";
  };

  let originalHeroes = {};
  pullHeroes().then((heroes) => {
    originalHeroes = heroes;
    heroesJsonLog.textContent = "Loaded!";
  });

  //==========//
  // PASSWORD //
  //==========//
  const PASSWORD_STORAGE_KEY = "fame-admin-password";
  const savePassword = () => {
    localStorage.setItem(PASSWORD_STORAGE_KEY, passwordInput.value);
  };

  const loadPassword = () => {
    const apiKey = localStorage.getItem(PASSWORD_STORAGE_KEY);
    passwordInput.value = apiKey;
    updateAdminControls();
  };

  const updateAdminControls = () => {
    if (passwordInput.value === "") {
      heroesJsonInput.setAttribute("readonly", true);
      heroesJsonPushButton.setAttribute("disabled", true);
    } else {
      heroesJsonInput.removeAttribute("readonly");
      heroesJsonPushButton.removeAttribute("disabled");
    }
  };

  window.handlePasswordInput = () => {
    savePassword();
    updateAdminControls();
  };

  loadPassword();
</script>
