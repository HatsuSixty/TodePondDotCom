<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script
  data-goatcounter="https://todepond.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"></script>
<title>Tadi lab</title>
<link rel="shortcut icon" href="/favicon.png" />
<meta property="og:image" content="https://todepond.com/lab/og.png" />
<meta property="og:title" content="Tadi lab" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Tadi lab" />
<meta name="twitter:description" content="" />
<meta name="twitter:image" content="https://todepond.com/lab/og.png" />

<link rel="stylesheet" href="/style.css" />

<canvas></canvas>

<style>
  * {
    box-sizing: border-box;
    touch-action: none;
  }

  body {
    margin: 0;
    overflow: hidden;
  }

  canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    image-rendering: pixelated;
    /* background-color: red; */
  }
</style>

<script>
  const canvas = document.querySelector("canvas");
  const ctx = canvas.getContext("2d");

  let imageData = null;

  const worldSize = 100;
  const cells = new Array(worldSize * worldSize).fill(0);
  const yellow = hexToRgb("#ffff46");
  const black = hexToRgb("#1f2736");

  const SAND_ID = 1;
  const AIR_ID = 0;

  canvas.width = worldSize;
  canvas.height = worldSize;
  imageData = ctx.createImageData(worldSize, worldSize);

  function fillRandomCells() {
    for (let i = 0; i < cells.length; i++) {
      cells[i] = Math.random() > 0.5 ? SAND_ID : AIR_ID;
    }
  }

  function hexToRgb(hex) {
    return [
      parseInt(hex.slice(1, 3), 16),
      parseInt(hex.slice(3, 5), 16),
      parseInt(hex.slice(5, 7), 16),
    ];
  }

  function drawEntireWorld() {
    for (let i = 0; i < cells.length; i++) {
      const color = cells[i] === SAND_ID ? yellow : black;
      const index = i * 4;
      imageData.data[index + 0] = color[0];
      imageData.data[index + 1] = color[1];
      imageData.data[index + 2] = color[2];
      imageData.data[index + 3] = 255;
    }
    ctx.putImageData(imageData, 0, 0);
  }

  let previousPointerPosition = null;

  function handleTick() {
    drawEntireWorld();
    if (pointer.down) {
      let [x, y] = pointer.position;

      if (x < 0 || x >= worldSize || y < 0 || y >= worldSize) {
        x = Math.min(Math.max(x, 0), worldSize - 1);
        y = Math.min(Math.max(y, 0), worldSize - 1);
        return;
      }

      if (previousPointerPosition) {
      }
      const index = y * worldSize + x;
      cells[index] = SAND_ID;
    }
    requestAnimationFrame(handleTick);
  }

  requestAnimationFrame(handleTick);

  // fillRandomCells();

  const pointer = {
    position: null,
    down: null,
  };

  function handlePointerEvent(e) {
    pointer.position = [
      Math.floor((e.clientX / window.innerWidth) * worldSize),
      Math.floor((e.clientY / window.innerHeight) * worldSize),
    ];
  }
  canvas.addEventListener("pointerdown", (event) => {
    pointer.down = true;
    handlePointerEvent(event);
  });

  canvas.addEventListener("pointermove", (event) => {
    handlePointerEvent(event);
  });

  canvas.addEventListener("pointerup", () => {
    pointer.down = false;
    handlePointerEvent(event);
  });
</script>
